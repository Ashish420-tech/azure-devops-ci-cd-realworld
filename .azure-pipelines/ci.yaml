trigger:
- main

# -------------------------
# AGENT POOL (Self-hosted)
# -------------------------
pool:
  name: Default

# -------------------------
# VARIABLES
# -------------------------
variables:
- group: prod-secrets                 # Variable group with DB_PASSWORD (secret)
- name: appName
  value: azure-devops-ci-cd-realworld

# -------------------------
# STAGES
# -------------------------
stages:

# =========================
# BUILD STAGE (Always runs)
# =========================
- stage: Build
  displayName: Build Stage
  jobs:
  - job: BuildJob
    displayName: Build Job
    steps:
    - script: |
        echo "========== BUILD START =========="
        date
        echo "Application: $(appName)"
        echo "Listing repository files:"
        ls -R
        echo "========== BUILD END =========="
      displayName: Build application

# =========================
# TEST STAGE (Always runs)
# =========================
- stage: Test
  displayName: Test Stage
  dependsOn: Build
  jobs:
  - job: TestJob
    displayName: Test Job
    steps:
    - script: |
        echo "========== TEST START =========="
        echo "Running tests for $(appName)"
        echo "All tests passed"
        echo "========== TEST END =========="
      displayName: Run tests

# =========================
# DEPLOY TO DEV
# Only runs from main
# =========================
- stage: Deploy_Dev
  displayName: Deploy to Dev
  dependsOn: Test
  condition: |
    and(
      succeeded(),
      eq(variables['Build.SourceBranch'], 'refs/heads/main')
    )
  jobs:
  - deployment: DevDeploy
    displayName: Dev Deployment
    environment: dev
    strategy:
      runOnce:
        deploy:
          steps:
          - script: |
              echo "========== DEV DEPLOY =========="
              echo "Deploying $(appName) to DEV"
              echo "========== DEV DEPLOY COMPLETE =========="
            displayName: Deploy to Dev

# =========================
# DEPLOY TO PROD (HARDENED)
# Only runs from main + approval
# =========================
- stage: Deploy_Prod
  displayName: Deploy to Prod
  dependsOn: Deploy_Dev
  condition: |
    and(
      succeeded(),
      eq(variables['Build.SourceBranch'], 'refs/heads/main')
    )
  jobs:
  - deployment: ProdDeploy
    displayName: Prod Deployment
    environment: prod              # Manual approval configured here
    strategy:
      runOnce:
        deploy:
          steps:
          - script: |
              echo "========== PROD DEPLOY =========="
              echo "Deploying $(appName) to PROD"
              echo "Using DB password: $(DB_PASSWORD)"
              echo "========== PROD DEPLOY COMPLETE =========="
            displayName: Deploy to Prod
